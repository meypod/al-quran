name: build & upload linux artifacts

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to upload artifacts to (leave empty for latest)'
        required: false
        default: ''

jobs:
  build_x64:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    if: |
      github.event_name == 'workflow_dispatch' || 
      (startsWith(github.ref, 'refs/tags/v') && contains(github.ref, '.') && !contains(github.ref, '-')) ||
      (startsWith(github.ref, 'refs/tags/v') && endsWith(github.ref, '-android'))
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          submodules: "true"

      - name: Get tag
        id: get_tag
        shell: bash
        run: |
          TAG="${{ github.event.inputs.tag }}"
          if [ -z "$TAG" ]; then
            git fetch --tags
            TAG=$(git tag --sort=-creatordate | head -n 1)
          fi
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          CLEAN_VERSION="${TAG#v}"
          if [ -z "$CLEAN_VERSION" ]; then
            exit 1
          fi
          echo "clean_version=$CLEAN_VERSION" >> $GITHUB_OUTPUT

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable

      - name: Install Flutter dependencies
        run: flutter pub get

      - name: Install required tools & pkgs
        run: |
          sudo apt-get update
          sudo apt-get install -y ruby ruby-dev build-essential rpm libgtk-3-dev fuse libfuse2
          sudo gem install --no-document fpm
          wget -O appimagetool https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
          chmod +x appimagetool

      - name: Build linux app for x86_64
        run: flutter build linux --release --no-pub --suppress-analytics --target-platform=linux-x64

      - name: Package into AppImage
        env:
          CLEAN_VERSION: ${{ steps.get_tag.outputs.clean_version }}
        run: |
            DIST_DIR="dist"
            BUILD_DIR="build/linux/x64/release/bundle"
            APPDIR="AppDir"
            mkdir -p "$DIST_DIR"
            mkdir -p "$APPDIR/usr/bin" "$APPDIR/usr/share/metainfo/" "$APPDIR/usr/share/applications/" "$APPDIR/usr/share/icons/hicolor/256x256/apps/"
            cp -r "$BUILD_DIR"/* "$APPDIR/usr/bin"
            cat > "$APPDIR/AppRun" << 'EOF'
            #!/bin/sh
            export LD_LIBRARY_PATH="$APPDIR/usr/bin/lib:$LD_LIBRARY_PATH"
            exec "$APPDIR/usr/bin/al_quran" "$@"
            EOF
            cp linux/icon.png "$APPDIR/usr/share/icons/hicolor/256x256/apps/al_quran.png"
            ln -sf "usr/share/icons/hicolor/256x256/apps/al_quran.png" "$APPDIR/.DirIcon"
            ln -sf "usr/share/icons/hicolor/256x256/apps/al_quran.png" "$APPDIR/al_quran.png"
            cp "linux/al_quran.metadata.xml" "$APPDIR/usr/share/metainfo/com.github.meypod.al_quran.appdata.xml"
            cp "linux/al_quran.appimage.desktop" "$APPDIR/usr/share/applications/al_quran.desktop"
            ln -sf "usr/share/applications/al_quran.desktop" "$APPDIR/al_quran.desktop"
            chmod +x "$APPDIR/usr/bin/al_quran"
            chmod +x "$APPDIR/AppRun"
            OUTPUT_FILE="$DIST_DIR/al_quran_v${CLEAN_VERSION}_x64.AppImage"
            ls -la "$APPDIR"
            ARCH=x86_64 VERSION="$CLEAN_VERSION" ./appimagetool "$APPDIR" "$OUTPUT_FILE"

      - name: Package into rpm & deb
        env:
          TAG_VERSION: ${{ steps.get_tag.outputs.tag }}
          CLEAN_VERSION: ${{ steps.get_tag.outputs.clean_version }}
          REPOSITORY: ${{ github.repository }}
        run: |
          APP_NAME="al_quran"
          DIST_DIR="dist"
          ARCH="x64"
          BUILD_DIR="build/linux/${ARCH}/release/bundle"
          STAGING_ROOT="pkgroot"
          rm -rf "$STAGING_ROOT"
          mkdir -p "$STAGING_ROOT/opt/$APP_NAME"
          cp -r "$BUILD_DIR"/. "$STAGING_ROOT/opt/$APP_NAME/"
          install -Dm644 linux/icon.png "$STAGING_ROOT/usr/share/icons/hicolor/256x256/apps/${APP_NAME}.png"
          install -Dm644 "linux/$APP_NAME.desktop" "$STAGING_ROOT/usr/share/applications/$APP_NAME.desktop"
          install -d "$STAGING_ROOT/usr/bin"
          ln -sf "/opt/$APP_NAME/$APP_NAME" "$STAGING_ROOT/usr/bin/$APP_NAME"
          mkdir -p "$DIST_DIR"
          for TARGET in deb rpm; do
            if [ "$TARGET" = "deb" ]; then
              ARCH="amd64"
              DEPENDS=(-d "libgtk-3-0" -d "libblkid1" -d "liblzma5")
            else
              ARCH="x86_64"
              DEPENDS=(-d "gtk3" -d "libblkid" -d "xz-libs")
            fi
            OUTPUT_FILE="$DIST_DIR/${APP_NAME}_v${CLEAN_VERSION}_${ARCH}.${TARGET}"
            fpm -s dir -t "$TARGET" \
              -n "$APP_NAME" \
              -v "$CLEAN_VERSION" \
              --architecture "$ARCH" \
              --license "AGPL-3.0" \
              --description "Al-Quran desktop application" \
              --url "https://github.com/$REPOSITORY" \
              --prefix "/" \
              --package "$OUTPUT_FILE" \
              -C "$STAGING_ROOT" \
              "${DEPENDS[@]}" .
          done

      - name: Release on GitHub
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ steps.get_tag.outputs.tag }}
          omitBody: true
          omitBodyDuringUpdate: true
          omitName: true
          allowUpdates: true
          replacesArtifacts: true
          updateOnlyUnreleased: false
          artifacts: dist/*.deb,dist/*.rpm,dist/*.AppImage
