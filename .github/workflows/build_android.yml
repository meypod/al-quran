name: build & upload android artifacts

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag to upload artifacts to (leave empty for latest)"
        required: false
        default: ""

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    if: |
      github.event_name == 'workflow_dispatch' || 
      (startsWith(github.ref, 'refs/tags/v') && contains(github.ref, '.') && !contains(github.ref, '-')) ||
      (startsWith(github.ref, 'refs/tags/v') && endsWith(github.ref, '-android'))

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          submodules: "true"

      - name: Get tag
        id: get_tag
        shell: bash
        run: |
          TAG="${{ github.event.inputs.tag }}"
          if [ -z "$TAG" ]; then
            git fetch --tags
            TAG=$(git tag --sort=-creatordate | head -n 1)
          fi
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - name: Setup java
        uses: actions/setup-java@v5
        with:
          distribution: "temurin"
          java-version: "21"

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable

      - name: Install Dependencies
        run: flutter pub get

      - name: Build appBundle
        run: flutter build appbundle --release --no-pub --suppress-analytics

      - name: Build Split APKs
        run: flutter build apk --release --split-per-abi --no-pub --suppress-analytics

      - name: Rename Split APKs
        run: |
          VERSION=$(grep 'version:' pubspec.yaml | sed 's/version: \([^+]*\).*/\1/')
          BASE_CODE=$(grep 'version:' pubspec.yaml | sed 's/.*+//')
          ARM64_CODE=$((BASE_CODE * 10 + 1))
          ARMEABI_CODE=$((BASE_CODE * 10 + 2))
          X86_64_CODE=$((BASE_CODE * 10 + 3))
          mv build/app/outputs/flutter-apk/app-arm64-v8a-release.apk "build/app/outputs/flutter-apk/al_quran_android_${VERSION}_${ARM64_CODE}_arm64-v8a.apk"
          mv build/app/outputs/flutter-apk/app-armeabi-v7a-release.apk "build/app/outputs/flutter-apk/al_quran_android_${VERSION}_${ARMEABI_CODE}_armeabi-v7a.apk"
          mv build/app/outputs/flutter-apk/app-x86_64-release.apk "build/app/outputs/flutter-apk/al_quran_android_${VERSION}_${X86_64_CODE}_x86_64.apk"

      - name: Rename Bundle
        run: |
          VERSION=$(grep 'version:' pubspec.yaml | sed 's/version: \([^+]*\).*/\1/')
          VERSIONCODE=$(grep 'version:' pubspec.yaml | sed 's/.*+//')
          mv build/app/outputs/bundle/release/app-release.aab "build/app/outputs/bundle/release/al_quran_android_${VERSION}_${VERSIONCODE}.aab"

      - name: Sign Android Apk & Bundle files
        if: ${{ github.event_name == 'release'}}
        run: |
          export BUILD_TOOLS_DIR="$ANDROID_HOME/build-tools/$(ls $ANDROID_HOME/build-tools | sort -V | tail -n 1)"
          echo "Using build-tools: $BUILD_TOOLS_DIR"
          "$BUILD_TOOLS_DIR/zipalign" -c -v 4 build/app/outputs/flutter-apk/*.apk
          printf '%s' "$ANDROID_SIGNING_KEY" | base64 -d > keystore.jks
          for apk in build/app/outputs/flutter-apk/*.apk; do
            "$BUILD_TOOLS_DIR/apksigner" sign --ks keystore.jks --ks-key-alias "$ANDROID_KEY_ALIAS" --ks-pass "pass:$ANDROID_KEY_STORE_PASSWORD" --key-pass "pass:$ANDROID_KEY_PASSWORD" "$apk"
          done
          for file in build/app/outputs/bundle/release/*.aab; do
            zip -d "$file" META-INF/\*
            jarsigner -sigalg SHA256withRSA -digestalg SHA-256 -keystore keystore.jks -storepass "$ANDROID_KEY_STORE_PASSWORD" -keypass "$ANDROID_KEY_PASSWORD" "$file" "$ANDROID_KEY_ALIAS"
          done
        env:
          ANDROID_SIGNING_KEY: ${{ secrets.ANDROID_SIGNING_KEY }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_KEY_STORE_PASSWORD: ${{ secrets.ANDROID_KEY_STORE_PASSWORD }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}

      - name: Release on GitHub
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ steps.get_tag.outputs.tag }}
          omitBody: true
          omitBodyDuringUpdate: true
          omitName: true
          allowUpdates: true
          replacesArtifacts: true
          updateOnlyUnreleased: false
          artifacts: build/app/outputs/flutter-apk/*.apk,build/app/outputs/bundle/release/*.aab

  upload_play_store:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    needs: build

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Get tag
        id: get_tag
        shell: bash
        run: |
          TAG="${{ github.event.inputs.tag }}"
          if [ -z "$TAG" ]; then
            git fetch --tags
            TAG=$(git tag --sort=-creatordate | head -n 1)
          fi
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - name: Download AAB from GitHub Release
        env:
          TAG: ${{ steps.get_tag.outputs.tag }}
          CLEAN_VERSION: ${{ steps.get_tag.outputs.clean_version }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          RELEASE_ID=$(gh api repos/${GITHUB_REPOSITORY}/releases/tags/$TAG --jq '.id')
          ASSET_ID=$(gh api repos/${GITHUB_REPOSITORY}/releases/$RELEASE_ID/assets --jq '.[] | select(.name | endswith(".aab")) | .id')
          gh api repos/${GITHUB_REPOSITORY}/releases/assets/$ASSET_ID --method GET -H "Accept: application/octet-stream" > app-release.aab

      - name: Upload to Play Store
        id: play-store-upload
        if: ${{ github.event_name == 'release' && !contains(github.ref, '-rc') }}
        uses: r0adkll/upload-google-play@v1
        continue-on-error: true
        with:
          serviceAccountJsonPlainText: ${{ secrets.SERVICE_ACCOUNT_JSON }}
          packageName: com.github.meypod.al_quran
          releaseFiles: app-release.aab
          track: production
          status: draft
        #  changesNotSentForReview: true

      - name: Delete AAB from GitHub Release
        if: ${{ github.event_name == 'release' && !contains(github.ref, '-rc') && steps.play-store-upload.outcome == 'success' }}
        uses: actions/github-script@v8
        env:
          TAG: ${{ steps.get_tag.outputs.tag }}
        with:
          retries: 3
          script: |
            const fs = require('fs');
            const path = require('path');

            const release = await github.rest.repos.getReleaseByTag({
                owner: context.repo.owner,
                repo: context.repo.repo,
                tag: process.env.TAG
            });

            const aabAssets = release.data.assets.filter(asset => asset.name.endsWith('.aab'));

            for (const asset of aabAssets) {
              await github.rest.repos.deleteReleaseAsset({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  asset_id: asset.id
              });
              console.log(`Deleted ${asset.name}`);
            }
